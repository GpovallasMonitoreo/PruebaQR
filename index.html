<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Argos AR: Disaster</title>
    
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    <script src="https://unpkg.com/aframe-particle-system-component@1.0.x/dist/aframe-particle-system-component.min.js"></script>

    <style>
        body { margin: 0; background: #000; }
        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            color: red; font-family: Impact, sans-serif; font-size: 2em;
            pointer-events: none; z-index: 10;
            text-shadow: 2px 2px 0px #000;
        }
        .hidden { display: none !important; }
    </style>

    <script>
        AFRAME.registerComponent('disaster-manager', {
            init: function () {
                const el = this.el;
                const meteor = document.querySelector('#meteor');
                const explosion = document.querySelector('#explosion-particles');
                const fire = document.querySelector('#fire-particles');
                const sound = document.querySelector('#sfx-explosion');
                const smoke = document.querySelector('#smoke-particles');

                // Ocultar efectos al inicio
                explosion.setAttribute('visible', false);
                fire.setAttribute('visible', false);
                smoke.setAttribute('visible', false);

                el.addEventListener('targetFound', () => {
                    console.log("¡IMPACTO INMINENTE!");
                    
                    // 1. El meteorito cae rápido
                    meteor.setAttribute('animation', {
                        property: 'position',
                        from: '0 0 4', // Empieza lejos (fuera de pantalla)
                        to: '0 0 0',   // Golpea la pantalla
                        dur: 600,      // Muy rápido (0.6 seg)
                        easing: 'easeInQuad'
                    });

                    // 2. Al momento del impacto (600ms después)
                    setTimeout(() => {
                        // Ocultamos el meteoro (ya "entró" en la pared)
                        meteor.setAttribute('visible', false);

                        // SONIDO
                        sound.components.sound.playSound();

                        // EXPLOSIÓN VISUAL
                        explosion.setAttribute('visible', true);
                        fire.setAttribute('visible', true);
                        smoke.setAttribute('visible', true);

                        // Vibración del celular (Haptic Feedback)
                        if (navigator.vibrate) navigator.vibrate([200, 100, 200, 100, 500]);

                    }, 600);
                });

                el.addEventListener('targetLost', () => {
                    // Resetear todo para la próxima vez
                    meteor.setAttribute('visible', true);
                    meteor.removeAttribute('animation');
                    meteor.setAttribute('position', '0 0 4');
                    explosion.setAttribute('visible', false);
                    fire.setAttribute('visible', false);
                    smoke.setAttribute('visible', false);
                    sound.components.sound.stopSound();
                });
            }
        });
    </script>
</head>
<body>
    <div id="overlay">⚠️ PELIGRO SÍSMICO</div>

    <a-scene 
        mindar-image="imageTargetSrc: ./targets.mind;" 
        color-space="sRGB" 
        renderer="colorManagement: true, physicallyCorrectLights" 
        vr-mode-ui="enabled: false" 
        device-orientation-permission-ui="enabled: false">

        <a-assets>
            <a-asset-item id="rock-model" src="https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/Asteroid/glTF/Asteroid.gltf"></a-asset-item>
            <audio id="explosion-sound" src="https://cdn.freesound.org/previews/156/156031_2703579-lq.mp3" preload="auto"></audio>
        </a-assets>

        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <a-entity mindar-image-target="targetIndex: 0" disaster-manager>

            <a-entity 
                id="meteor"
                gltf-model="#rock-model"
                scale="0.05 0.05 0.05"
                rotation="0 0 0"
                position="0 0 4"> <a-animation attribute="rotation" to="360 360 0" repeat="indefinite" dur="2000"></a-animation>
            </a-entity>

            

            <a-entity id="fire-particles" position="0 0 0"
                particle-system="preset: dust; texture: https://cdn.aframe.io/fire/fire.png; color: #ff4400,#ff8800; particleCount: 1000; size: 2; velocityValue: 0 1 0; velocitySpread: 0.5 0.5 0.5; maxAge: 1;">
            </a-entity>

            <a-entity id="smoke-particles" position="0 0 0"
                particle-system="preset: dust; color: #000000,#333333; particleCount: 500; size: 4; velocityValue: 0 0.5 0; opacity: 0.5;">
            </a-entity>

            <a-entity id="explosion-particles" position="0 0 0"
                particle-system="preset: explosion; color: #ffff00; particleCount: 200; texture: https://cdn.aframe.io/fire/fire.png;">
            </a-entity>

            <a-entity id="sfx-explosion" sound="src: #explosion-sound; volume: 4; positional: false"></a-entity>

            <a-light type="point" color="#ffaa00" distance="5" decay="2" intensity="2">
                <a-animation attribute="intensity" from="2" to="0.5" dur="100" repeat="indefinite" easing="linear"></a-animation>
            </a-light>

        </a-entity>
    </a-scene>
</body>
</html>
