<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Argos AR: Desastre Nativo</title>
    
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>

    <style>
        body { margin: 0; }
        /* Forzamos que el video tenga prioridad visual si algo falla en el 3D */
        video { z-index: -1 !important; } 
        
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 10;
            display: flex; justify-content: center; align-items: center;
        }
        .warning {
            color: red; font-family: 'Arial Black', sans-serif; font-size: 2rem;
            text-transform: uppercase; text-shadow: 0 0 10px yellow;
            animation: blink 0.5s infinite; display: none;
        }
        @keyframes blink { 50% { opacity: 0; } }
    </style>

    <script>
        // COMPONENTE: GENERADOR DE EXPLOSIÓN PROPIA
        AFRAME.registerComponent('collision-handler', {
            init: function () {
                const el = this.el;
                const meteor = document.querySelector('#meteor');
                const warning = document.querySelector('.warning');
                
                // Crear 20 fragmentos de escombros ocultos
                this.fragments = [];
                for(let i=0; i<30; i++) {
                    let fragment = document.createElement('a-dodecahedron');
                    fragment.setAttribute('color', i % 2 === 0 ? '#ffaa00' : '#555'); // Naranja y Gris
                    fragment.setAttribute('radius', Math.random() * 0.1 + 0.05);
                    fragment.setAttribute('visible', false);
                    el.appendChild(fragment);
                    this.fragments.push(fragment);
                }

                el.addEventListener('targetFound', () => {
                    console.log("Objetivo encontrado. Iniciando secuencia.");
                    warning.style.display = 'block';

                    // 1. Resetear Meteoro
                    meteor.setAttribute('visible', true);
                    meteor.setAttribute('position', '0 2 2'); // Arriba y afuera
                    
                    // 2. Animar Caída
                    meteor.removeAttribute('animation');
                    meteor.setAttribute('animation', {
                        property: 'position',
                        to: '0 0 0',
                        dur: 800,
                        easing: 'easeInCubic'
                    });

                    // 3. Impacto (después de 800ms)
                    setTimeout(() => {
                        this.explode();
                        meteor.setAttribute('visible', false); // Ocultar meteoro
                        warning.style.display = 'none'; // Quitar alerta
                        // Vibrar
                        if(navigator.vibrate) navigator.vibrate(500);
                    }, 800);
                });

                el.addEventListener('targetLost', () => {
                    warning.style.display = 'none';
                    meteor.setAttribute('visible', false);
                });
            },

            explode: function() {
                // Disparar los fragmentos en direcciones aleatorias
                this.fragments.forEach(frag => {
                    frag.setAttribute('position', '0 0 0');
                    frag.setAttribute('visible', true);
                    
                    // Calcular dirección aleatoria explosiva
                    const x = (Math.random() - 0.5) * 4;
                    const y = (Math.random() - 0.5) * 4;
                    const z = (Math.random() - 0.5) * 4; // Hacia afuera

                    frag.setAttribute('animation', {
                        property: 'position',
                        to: `${x} ${y} ${z}`,
                        dur: 1000,
                        easing: 'easeOutQuad'
                    });
                    
                    // Desaparecer (scale a 0)
                    frag.setAttribute('animation__scale', {
                        property: 'scale',
                        to: '0 0 0',
                        dur: 1000,
                        easing: 'easeOutQuad'
                    });
                });
            }
        });
    </script>
</head>
<body>

    <div id="ui-layer">
        <div class="warning">⚠️ IMPACTO ⚠️</div>
    </div>

    <a-scene 
        mindar-image="imageTargetSrc: ./targets.mind; uiLoading: no; uiScanning: no;" 
        color-space="sRGB" 
        renderer="colorManagement: true, physicallyCorrectLights" 
        vr-mode-ui="enabled: false" 
        device-orientation-permission-ui="enabled: false">

        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <a-entity mindar-image-target="targetIndex: 0" collision-handler>
            
            <a-dodecahedron id="meteor" 
                radius="0.5" 
                color="#444" 
                roughness="1"
                visible="false"
                position="0 2 2">
                <a-sphere color="orange" radius="0.55" opacity="0.5" animation="property: scale; to: 1.2 1.2 1.2; dir: alternate; loop: true; dur: 100"></a-sphere>
            </a-dodecahedron>

            <a-light type="point" color="orange" position="0 0 2" intensity="2"></a-light>
            <a-light type="ambient" intensity="0.5"></a-light>

        </a-entity>
    </a-scene>
</body>
</html>
