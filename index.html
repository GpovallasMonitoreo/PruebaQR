<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Argos AR: Gran Entrada</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>

    <style>
        body { margin: 0; }
        .instructions {
            position: absolute; bottom: 10%; width: 100%; text-align: center;
            color: white; font-family: sans-serif; font-weight: bold; pointer-events: none; text-shadow: 2px 2px 2px #000;
        }
        .a-enter-vr-button { display: none; }
    </style>

    <script>
        // SCRIPT ORQUESTADOR: Coordina que todo pase cuando se detecta la imagen
        AFRAME.registerComponent('start-show', {
            init: function () {
                const el = this.el; // El target
                const robot = document.querySelector("#robot");
                const doorL = document.querySelector("#door-left");
                const doorR = document.querySelector("#door-right");
                
                // Cuando encuentra la imagen...
                el.addEventListener('targetFound', event => {
                    console.log("Target encontrado - Iniciando secuencia");
                    
                    // 1. Disparar apertura de puertas
                    // 'emit' lanza el evento que las animaciones están esperando (startEvents)
                    doorL.emit('open');
                    doorR.emit('open');

                    // 2. Esperar 500ms y hacer que el robot camine hacia afuera
                    setTimeout(() => {
                        robot.emit('walk-out');
                    }, 500);
                });

                // Resetear si se pierde (opcional, para que se cierre de nuevo)
                el.addEventListener('targetLost', event => {
                    console.log("Target perdido - Reseteando");
                    // Aquí podrías emitir eventos de 'close' si quisieras
                });
            }
        });
    </script>
</head>
<body>
    <div class="instructions">¡Mantén la cámara estable!</div>

    <a-scene 
        mindar-image="imageTargetSrc: ./targets.mind; uiScanning: no;" 
        color-space="sRGB" 
        renderer="colorManagement: true, physicallyCorrectLights" 
        vr-mode-ui="enabled: false" 
        device-orientation-permission-ui="enabled: false">

        <a-assets>
            <a-asset-item id="robot-model" src="https://raw.githubusercontent.com/mrdoob/three.js/master/examples/models/gltf/RobotExpressive/RobotExpressive.glb"></a-asset-item>
            <img id="metal-tex" src="https://cdn.aframe.io/a-painter/images/floor.jpg">
        </a-assets>

        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <a-entity mindar-image-target="targetIndex: 0" start-show>

            <a-entity position="0 0 0.01">
                
                <a-box id="door-left" 
                    position="-0.25 0 0" 
                    width="0.5" height="1" depth="0.05"
                    src="#metal-tex" color="#555"
                    animation="property: position; to: -0.8 0 0; dur: 2000; easing: easeInOutCubic; startEvents: open">
                </a-box>

                <a-box id="door-right" 
                    position="0.25 0 0" 
                    width="0.5" height="1" depth="0.05"
                    src="#metal-tex" color="#555"
                    animation="property: position; to: 0.8 0 0; dur: 2000; easing: easeInOutCubic; startEvents: open">
                </a-box>
            </a-entity>

            <a-plane position="0 0 -0.1" width="1.5" height="1.5" color="black"></a-plane>

            <a-entity 
                id="robot"
                gltf-model="#robot-model" 
                rotation="0 0 0" 
                position="0 -0.5 -2" 
                scale="0.3 0.3 0.3"
                animation-mixer="clip: Walking; loop: repeat"
                animation="property: position; to: 0 -0.5 0.5; dur: 4000; easing: easeOutQuad; startEvents: walk-out">
            </a-entity>

            <a-light type="point" color="#ffaa00" intensity="2" position="0 0 -0.5"></a-light>
            <a-light type="ambient" intensity="0.5"></a-light>

        </a-entity>
    </a-scene>
</body>
</html>
